# üóÑ FitTrack ‚Äî Database Schema (PostgreSQL 16)

## Overview
The FitTrack backend uses **PostgreSQL 16** as its primary database.
Schema version **2.0** (updated **2024-08-15**) standardises identifier columns as
`GENERATED BY DEFAULT AS IDENTITY`.
The ORM layer is implemented via **Dapper**, and schema evolution is managed through
**FluentMigrator**. All timestamps are stored in **UTC** and identifiers follow
snake_case naming.

---

## üß© users
Stores account information and user preferences.

| Column | Type | Constraints | Description |
|--------|------|--------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Unique user identifier |
| email | TEXT | UNIQUE, NOT NULL | User login |
| password_hash | TEXT | NOT NULL | Encrypted password (BCrypt) |
| goal | TEXT | NULL | ‚Äúlose_weight‚Äù, ‚Äúmaintain‚Äù, ‚Äúgain_weight‚Äù |
| water_goal_ml | INT | DEFAULT 2500 | Daily hydration target (FitTrack UA+) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Registration date |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Last profile update |

**Indexes**
```sql
CREATE UNIQUE INDEX idx_users_email ON users(email);
```

---

## ü•ó food_entries
Records all meals and nutrient values.

| Column | Type | Constraints | Description |
|--------|------|-------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Entry id |
| user_id | INT | NOT NULL, FK ‚Üí users(id) ON DELETE CASCADE | Owner |
| date | DATE | DEFAULT CURRENT_DATE | Meal date |
| name | TEXT | NOT NULL | Food or dish name |
| calories | INT | DEFAULT 0 | Energy value (kcal) |
| proteins | REAL | DEFAULT 0 | Protein (g) |
| fats | REAL | DEFAULT 0 | Fat (g) |
| carbs | REAL | DEFAULT 0 | Carbohydrate (g) |
| vitamins | JSONB | NULL | Map of vitamin ‚Üí value (e.g. {"C": 30,"B6": 0.2}) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Creation timestamp |

**Indexes**
```sql
CREATE INDEX idx_food_user_date ON food_entries(user_id, date);
```

---

## üíß water_entries
Tracks all hydration activity.

| Column | Type | Constraints | Description |
|--------|------|-------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Record id |
| user_id | INT | NOT NULL, FK ‚Üí users(id) ON DELETE CASCADE | Owner |
| date | DATE | DEFAULT CURRENT_DATE | Entry date |
| amount_ml | INT | NOT NULL | Water amount in milliliters |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Timestamp |

**Indexes**
```sql
CREATE INDEX idx_water_user_date ON water_entries(user_id, date);
```

---

## üåø vitamin_profiles
Stores the recommended and current vitamin levels for each user.

| Column | Type | Constraints | Description |
|--------|------|-------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Record id |
| user_id | INT | NOT NULL, FK ‚Üí users(id) ON DELETE CASCADE | Owner |
| vitamin_data | JSONB | NOT NULL | Key/value pairs of vitamin name ‚Üí {value, recommended, unit} |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Last update time |

**Example FitTrack UA+ Vitamin Snapshot**
```json
{
  "C": { "value": 70, "recommended": 90, "unit": "mg" },
  "D": { "value": 6, "recommended": 10, "unit": "¬µg" },
  "Hydration": { "value": 2100, "recommended": 2500, "unit": "ml", "target": "FitTrack UA+" }
}
```

**Sample Data Points (FitTrack UA+)**
```sql
INSERT INTO users (email, password_hash, goal, water_goal_ml)
VALUES ('alex@uat.fittrack', '<bcrypt>', 'maintain', 2600);

INSERT INTO water_entries (user_id, date, amount_ml)
VALUES (1, CURRENT_DATE, 325);

INSERT INTO stats_cache (user_id, date, calories_total, water_total_ml)
VALUES (1, CURRENT_DATE, 1850, 2100)
ON CONFLICT (user_id, date) DO UPDATE
    SET calories_total = EXCLUDED.calories_total,
        water_total_ml = EXCLUDED.water_total_ml,
        updated_at = CURRENT_TIMESTAMP;
```

---

## ‚è∞ reminders
Stores notification settings (hydration, meals, vitamins, etc.).

| Column | Type | Constraints | Description |
|--------|------|-------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Reminder id |
| user_id | INT | NOT NULL, FK ‚Üí users(id) ON DELETE CASCADE | Owner |
| type | TEXT | NOT NULL | ‚Äúwater‚Äù, ‚Äúmeal‚Äù, ‚Äúvitamin‚Äù |
| time | TIME | NOT NULL | First trigger time |
| interval_minutes | INT | DEFAULT 120 | Interval between notifications |
| enabled | BOOLEAN | DEFAULT true | Whether active |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Creation time |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Last edit time |

**Indexes**
```sql
CREATE INDEX idx_reminders_user_type ON reminders(user_id, type);
```

---

## üìä stats_cache (optional)
Cached daily summaries for quick analytics.

| Column | Type | Constraints | Description |
|--------|------|-------------|--------------|
| id | INTEGER GENERATED BY DEFAULT AS IDENTITY | PK | Record id |
| user_id | INT | NOT NULL, FK ‚Üí users(id) | Owner |
| date | DATE | NOT NULL, UNIQUE (user_id, date) | Day |
| calories_total | INT | DEFAULT 0 | Sum of calories |
| water_total_ml | INT | DEFAULT 0 | Total water intake |
| vitamins_summary | JSONB | NULL | Aggregated vitamin data |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Refresh timestamp |

**Indexes**
```sql
CREATE UNIQUE INDEX idx_stats_user_date ON stats_cache(user_id, date);
```

---

## ‚öôÔ∏è Relationships Summary
```
users 1‚îÄ‚àû food_entries
users 1‚îÄ‚àû water_entries
users 1‚îÄ‚àû vitamin_profiles
users 1‚îÄ‚àû reminders
users 1‚îÄ‚àû stats_cache
```

---

## üíæ Migration Example (FluentMigrator)
```csharp
[Migration(2025110101)]
public class CreateUsers : Migration
{
    public override void Up()
    {
        Create.Table("users")
            .WithColumn("id").AsInt32().PrimaryKey().Identity()
            .WithColumn("email").AsString(100).NotNullable()
            .WithColumn("password_hash").AsString(200).NotNullable()
            .WithColumn("goal").AsString(30).Nullable()
            .WithColumn("water_goal_ml").AsInt32().WithDefaultValue(2500)
            .WithColumn("created_at").AsDateTime().WithDefault(SystemMethods.CurrentUTCDateTime);
    }

    public override void Down() => Delete.Table("users");
}
```

---

## ‚úÖ Notes
- Use **snake_case** in database naming for consistency.
- All identity keys use `GENERATED BY DEFAULT AS IDENTITY`; avoid legacy `SERIAL`.
- Timestamp fields default to `CURRENT_TIMESTAMP`; triggers or application logic
  should maintain `updated_at` refreshes.
- Future extensions: sleep tracking, weight log, nutrient history (FitTrack UA+ roadmap).
- Use `REAL` for fractional nutrient precision unless domain rules require `NUMERIC`.
- Every Dapper repository should return `Task<T>` or `Task<IEnumerable<T>>`.

---

**Author:** FitTrack UA+ System Design  
**Version:** 2.0 (2024-08-15)
